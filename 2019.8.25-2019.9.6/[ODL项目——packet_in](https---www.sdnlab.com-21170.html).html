<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>[ODL项目——packet_in](https://www.sdnlab.com/21170.html)</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="u8nd" id="odl项目packetin"><a href="https://www.sdnlab.com/21170.html" target="_blank">ODL项目——packet_in</a></h1><p data-anchor-id="xh9r"><code>实验</code></p><hr><p data-anchor-id="o4jw">简单来讲(总结自己完成项目的整个过程) <br>
（1）将<a href="https://github.com/zhengyjs/TorinoZone/blob/master/实验总结/packet-in-flooding-defence-master.zip" target="_blank">源码文件夹</a>下载下来。一般默认的下载路径为：/家目录/下载，例如我的下载位置为/home/ajoy/下载；为压缩文件形式。 <br>
（2）将源码文件夹解压到/home/ajoy/program/ODL目录下，或者解压到你希望的任何文件夹。解压得到文件夹packet-in-flooding-defence-master。 <br>
（3）切换为root用户，进入/home/ajoy/program/ODL/packet-in-flooding-defence-master文件夹，编译该项目。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="oal7"><ol class="linenums"><li class="L0"><code><span class="pln">$ su </span><span class="pun">-</span></code></li><li class="L1"><code><span class="pln">\# cd </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">ajoy</span><span class="pun">/</span><span class="pln">program</span><span class="pun">/</span><span class="pln">ODL</span><span class="pun">/</span><span class="pln">packet</span><span class="pun">-</span><span class="kwd">in</span><span class="pun">-</span><span class="pln">flooding</span><span class="pun">-</span><span class="pln">defence</span><span class="pun">-</span><span class="pln">master</span></code></li><li class="L2"><code><span class="pln">\# mvn clean install </span><span class="pun">-</span><span class="typ">DskipTests</span></code></li></ol></pre><p data-anchor-id="dtrt">(4)编译成功后，打开OpenDayLight，安装openflowplugin和l2switch对应的feature，然后退出ODL，重新启动。当前目录为/home/ajoy/program/ODL/packet-in-flooding-defence-master。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="cequ"><ol class="linenums"><li class="L0"><code><span class="pln">\#cd karaf</span><span class="pun">/</span><span class="pln">target</span><span class="pun">/</span><span class="pln">assembly</span><span class="pun">/</span><span class="pln">bin</span><span class="pun">/</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> \#karaf        </span><span class="com">//运行ODL </span></code></li><li class="L2"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">restconf</span><span class="pun">-</span><span class="pln">all</span></code></li><li class="L3"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">l2switch</span><span class="pun">-</span><span class="kwd">switch</span><span class="pun">-</span><span class="pln">ui</span></code></li><li class="L4"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">openflowplugin</span><span class="pun">-</span><span class="pln">flow</span><span class="pun">-</span><span class="pln">services</span><span class="pun">-</span><span class="pln">ui </span></code></li><li class="L5"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">mdsal</span><span class="pun">-</span><span class="pln">all</span></code></li><li class="L6"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">dluxapps</span><span class="pun">-</span><span class="pln">applications</span></code></li><li class="L7"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">dluxapps</span><span class="pun">-</span><span class="pln">yangutils</span></code></li></ol></pre><p data-anchor-id="3g70">（5）测试功能。详见<a href="https://www.sdnlab.com/21170.html" target="_blank">教程</a></p><div class="md-section-divider"></div><h3 data-anchor-id="cx88" id="但是现在要知其然还要制其所以然故将整个项目及其代码进行详细地学习记录"><strong>但是，现在要知其然，还要制其所以然。故将整个项目及其代码进行详细地学习记录。</strong></h3><div class="md-section-divider"></div><h4 data-anchor-id="m51s" id="一项目搭建"><strong>一、项目搭建</strong></h4><p data-anchor-id="v98s">（1）创建maven项目。因为ODL应用基于OSGi实现进行模块化，并且其应用以maven存储库形式组织。以下命令只提供了原型的模板，即文件夹中应该包含什么文件或文件夹。详见《SDN环境部署与OpenDaylight开发入门》P368</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="b46i"><ol class="linenums"><li class="L0"><code><span class="pln">mvn archetype</span><span class="pun">:</span><span class="pln">generate </span><span class="pun">-</span><span class="typ">DarchetypeGroupId</span><span class="pun">=</span><span class="pln">org</span><span class="pun">.</span><span class="pln">opendaylight</span><span class="pun">.</span><span class="pln">controller </span><span class="pun">-</span><span class="typ">DarchetypeArtifactId</span><span class="pun">=</span><span class="pln">opendaylight</span><span class="pun">-</span><span class="pln">startup</span><span class="pun">-</span><span class="pln">archetype </span><span class="pun">-</span><span class="typ">DarchetypeRepository</span><span class="pun">=</span><span class="pln">http</span><span class="pun">:</span><span class="com">//nexus.opendaylight.org/content/repositories/opendaylight.release/ -DarchetypeCatalog=remote -DarchetypeVersion=1.3.0-Carbon</span></code></li></ol></pre><ul data-anchor-id="efl4">
<li>DarchetypeRepository：为格式下载的仓库，release为发行版；snapshot为未发行版。</li>
<li>DarchetypeCatalog：可供选择的原型目录，可以为<em>local</em>，即从本地选择原型；<em>remote</em>，即从Maven的中央仓库或者镜像中选择原型；<em>internet</em>，即联网下载。</li>
</ul><p data-anchor-id="i958">输入参数：指定原型中的文件夹名称。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="eik6"><ol class="linenums"><li class="L0"><code><span class="pln">groupId</span><span class="pun">：</span><span class="pln">org</span><span class="pun">.</span><span class="pln">opendaylight</span><span class="pun">.</span><span class="pln">defender</span></code></li><li class="L1"><code><span class="pln">artifactId</span><span class="pun">：</span><span class="pln">defender</span></code></li><li class="L2"><code><span class="pln">classPrefix</span><span class="pun">：</span><span class="pln">defender</span></code></li><li class="L3"><code><span class="pln">copyright</span><span class="pun">：</span><span class="kwd">no</span></code></li><li class="L4"><code><span class="pln">Y</span><span class="pun">：：</span><span class="pln">Y</span></code></li></ol></pre><p data-anchor-id="o9bo">（2）因为由以上命令创建的maven项目只具有基本功能，但是在packetin项目中还需要使用openflow协议和l2switch功能，所以还要在相关文件中添加依赖。</p><ul data-anchor-id="dhm1">
<li>修改defender/features/pom.xml <br>
在properties中增加openflowplugin和l2switch的版本号。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="jngt"><ol class="linenums"><li class="L0"><code><span class="pln">  </span><span class="tag">&lt;properties&gt;</span></code></li><li class="L1"><code><span class="pln">    </span><span class="tag">&lt;mdsal.model.version&gt;</span><span class="pln">0.10.0-Carbon</span><span class="tag">&lt;/mdsal.model.version&gt;</span></code></li><li class="L2"><code><span class="pln">    </span><span class="tag">&lt;mdsal.version&gt;</span><span class="pln">1.5.0-Carbon</span><span class="tag">&lt;/mdsal.version&gt;</span></code></li><li class="L3"><code><span class="pln">    </span><span class="tag">&lt;restconf.version&gt;</span><span class="pln">1.5.0-Carbon</span><span class="tag">&lt;/restconf.version&gt;</span></code></li><li class="L4"><code><span class="pln">    </span><span class="tag">&lt;yangtools.version&gt;</span><span class="pln">1.1.0-Carbon</span><span class="tag">&lt;/yangtools.version&gt;</span></code></li><li class="L5"><code><span class="pln">    </span><span class="tag">&lt;dluxapps.version&gt;</span><span class="pln">0.5.0-Carbon</span><span class="tag">&lt;/dluxapps.version&gt;</span></code></li><li class="L6"><code><span class="pln">    </span><span class="tag">&lt;openflowplugin.version&gt;</span><span class="pln">0.4.0-Carbon</span><span class="tag">&lt;/openflowplugin.version&gt;</span></code></li><li class="L7"><code><span class="pln">    </span><span class="tag">&lt;l2switch.version&gt;</span><span class="pln">0.5.0-Carbon</span><span class="tag">&lt;/l2switch.version&gt;</span></code></li><li class="L8"><code><span class="pln">    </span><span class="tag">&lt;configfile.directory&gt;</span><span class="pln">etc/opendaylight/karaf</span><span class="tag">&lt;/configfile.directory&gt;</span></code></li><li class="L9"><code><span class="pln">  </span><span class="tag">&lt;/properties&gt;</span></code></li></ol></pre><p data-anchor-id="uirc">在dependencies中增加依赖关系。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="f6v5"><ol class="linenums"><li class="L0"><code><span class="pln">   </span><span class="tag">&lt;dependency&gt;</span></code></li><li class="L1"><code><span class="pln">      </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.opendaylight.openflowplugin</span><span class="tag">&lt;/groupId&gt;</span></code></li><li class="L2"><code><span class="pln">      </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">features-openflowplugin</span><span class="tag">&lt;/artifactId&gt;</span></code></li><li class="L3"><code><span class="pln">      </span><span class="tag">&lt;classifier&gt;</span><span class="pln">features</span><span class="tag">&lt;/classifier&gt;</span></code></li><li class="L4"><code><span class="pln">      </span><span class="tag">&lt;version&gt;</span><span class="pln">${openflowplugin.version}</span><span class="tag">&lt;/version&gt;</span></code></li><li class="L5"><code><span class="pln">      </span><span class="tag">&lt;type&gt;</span><span class="pln">xml</span><span class="tag">&lt;/type&gt;</span></code></li><li class="L6"><code><span class="pln">    </span><span class="tag">&lt;/dependency&gt;</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">    </span><span class="tag">&lt;dependency&gt;</span></code></li><li class="L9"><code><span class="pln">      </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.opendaylight.l2switch</span><span class="tag">&lt;/groupId&gt;</span></code></li><li class="L0"><code><span class="pln">      </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">features-l2switch</span><span class="tag">&lt;/artifactId&gt;</span></code></li><li class="L1"><code><span class="pln">      </span><span class="tag">&lt;classifier&gt;</span><span class="pln">features</span><span class="tag">&lt;/classifier&gt;</span></code></li><li class="L2"><code><span class="pln">      </span><span class="tag">&lt;version&gt;</span><span class="pln">${l2switch.version}</span><span class="tag">&lt;/version&gt;</span></code></li><li class="L3"><code><span class="pln">      </span><span class="tag">&lt;type&gt;</span><span class="pln">xml</span><span class="tag">&lt;/type&gt;</span></code></li><li class="L4"><code><span class="pln">    </span><span class="tag">&lt;/dependency&gt;</span></code></li></ol></pre><ul data-anchor-id="jrzy">
<li>修改defender/features/src/main/features/features.xml <br>
增加下载openflowplugin和l2switch的仓库。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mchz"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="tag">&lt;repository&gt;</span><span class="pln">mvn:org.opendaylight.openflowplugin/features-openflowplugin/${openflowplugin.version}/xml/features</span><span class="tag">&lt;/repository&gt;</span></code></li><li class="L1"><code><span class="pln">  </span><span class="tag">&lt;repository&gt;</span><span class="pln">mvn:org.opendaylight.l2switch/features-l2switch/${l2switch.version}/xml/features</span><span class="tag">&lt;/repository&gt;</span></code></li></ol></pre><p data-anchor-id="sj6k"><strong>总结：增加features涉及到两个文件，均在features文件夹下。在pom.xml中增加版本号和依赖关系；在features.xml中增加仓库位置。</strong></p><p data-anchor-id="62ay">（3）编译该项目，在defender文件夹下。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vjku"><ol class="linenums"><li class="L0"><code><span class="pln">mvn clean install </span><span class="pun">-</span><span class="typ">DskipTests</span></code></li></ol></pre><p data-anchor-id="2rer">（4）导入eclipse中，在eclipse中配置maven环境，详见<a href="https://wiki.opendaylight.org/view/GettingStarted%3a_Eclipse" target="_blank">官网</a>。 <br>
<strong>到此处，maven项目搭建完成，即应用的基本框架已经搭好。下面是对ODL应用的开发。</strong></p><div class="md-section-divider"></div><h4 data-anchor-id="gf1c" id="二监测模块"><strong>二、监测模块</strong></h4><p data-anchor-id="g6mo">监测模块的实现主要通过统计一定时间内的packetin数据包数量，计算速率，并和之前定义好的阈值进行比较。如果超过阈值，就将消息报告给处理模块。 <br>
（1）在yang中定义该过程中需要用到的数据模型 <br>
在api/src/main/yang，创建defenderplugin.yang(其中自动生成defender.yang)，写入notification lowWaterMarkBreached和container LWM。</p><ul data-anchor-id="neao">
<li><em>notification lowWaterMarkBreached</em> 将超过阈值的数据包的源/目的IP地址、源/目的MAC、源/目的端口和协议类型记录下来，发送给处理模块，即为发送给处理模块的数据格式。</li>
<li><em>container LWM</em> 定义威胁数据包在datastore中的存储结构。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="42xc"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="com">// Notification消息传递IP地址和MAC地址等信息</span></code></li><li class="L1"><code><span class="pln">    notification lowWaterMarkBreached </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">        description</span></code></li><li class="L3"><code><span class="pln">                </span><span class="str">"Indicates that the Low Water Mark has Breached."</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">        leaf srcPort </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">            type uint16</span><span class="pun">;</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        leaf dstPort </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">            type uint16</span><span class="pun">;</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L0"><code><span class="pln">        leaf srcIP </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">            type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">        leaf dstIP </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">            type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pln">        leaf protocol </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">            type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pln">        leaf srcMac </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">            type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L2"><code><span class="pln">        leaf dstMac </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">            type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pln">    </span><span class="com">// 在datastore中存储的威胁信息的结构</span></code></li><li class="L7"><code><span class="pln">    container LWM </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">        list lowwatermark </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">            key secKey</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">            leaf secKey </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">            leaf nodeID </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pln">            leaf nodeConnectorID </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L8"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pln">            leaf srcMAC </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L1"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L2"><code><span class="pln">            leaf dstMAC </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">            leaf srcIP </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pln">            leaf dstIP </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">            leaf protocol </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">            leaf srcPort </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">                type uint16</span><span class="pun">;</span></code></li><li class="L6"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">            leaf dstPort </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">                type uint16</span><span class="pun">;</span></code></li><li class="L9"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L0"><code><span class="pln">            leaf packetSize </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">                type uint16</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">            leaf upwardTime </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pln">            leaf downwardTime </span><span class="pun">{</span></code></li><li class="L7"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L8"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pln">            config </span><span class="kwd">false</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="t2hy">（2）要统计packetin数据包，需要使用openflow协议，即调用openflowplugin对应的相关接口，所以在api/pom.xml添加openflowplugin的依赖。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="xtz4"><ol class="linenums"><li class="L0"><code><span class="pln">        </span><span class="tag">&lt;dependency&gt;</span></code></li><li class="L1"><code><span class="pln">            </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.opendaylight.openflowplugin.model</span><span class="tag">&lt;/groupId&gt;</span></code></li><li class="L2"><code><span class="pln">            </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">model-flow-base</span><span class="tag">&lt;/artifactId&gt;</span></code></li><li class="L3"><code><span class="pln">            </span><span class="tag">&lt;version&gt;</span><span class="pln">0.4.0-Carbon</span><span class="tag">&lt;/version&gt;</span></code></li><li class="L4"><code><span class="pln">        </span><span class="tag">&lt;/dependency&gt;</span></code></li><li class="L5"><code><span class="pln">        </span><span class="tag">&lt;dependency&gt;</span></code></li><li class="L6"><code><span class="pln">            </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.opendaylight.openflowplugin.model</span><span class="tag">&lt;/groupId&gt;</span></code></li><li class="L7"><code><span class="pln">            </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">model-flow-service</span><span class="tag">&lt;/artifactId&gt;</span></code></li><li class="L8"><code><span class="pln">            </span><span class="tag">&lt;version&gt;</span><span class="pln">0.4.0-Carbon</span><span class="tag">&lt;/version&gt;</span></code></li><li class="L9"><code><span class="pln">        </span><span class="tag">&lt;/dependency&gt;</span></code></li><li class="L0"><code><span class="pln">        </span><span class="tag">&lt;dependency&gt;</span></code></li><li class="L1"><code><span class="pln">            </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.opendaylight.openflowplugin</span><span class="tag">&lt;/groupId&gt;</span></code></li><li class="L2"><code><span class="pln">            </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">openflowplugin-api</span><span class="tag">&lt;/artifactId&gt;</span></code></li><li class="L3"><code><span class="pln">            </span><span class="tag">&lt;version&gt;</span><span class="pln">0.4.0-Carbon</span><span class="tag">&lt;/version&gt;</span></code></li><li class="L4"><code><span class="pln">        </span><span class="tag">&lt;/dependency&gt;</span></code></li><li class="L5"><code><span class="pln">        </span><span class="tag">&lt;dependency&gt;</span></code></li><li class="L6"><code><span class="pln">            </span><span class="tag">&lt;groupId&gt;</span><span class="pln">org.opendaylight.controller.model</span><span class="tag">&lt;/groupId&gt;</span></code></li><li class="L7"><code><span class="pln">            </span><span class="tag">&lt;artifactId&gt;</span><span class="pln">model-inventory</span><span class="tag">&lt;/artifactId&gt;</span></code></li><li class="L8"><code><span class="pln">            </span><span class="tag">&lt;version&gt;</span><span class="pln">1.5.0-Carbon</span><span class="tag">&lt;/version&gt;</span></code></li><li class="L9"><code><span class="pln">        </span><span class="tag">&lt;/dependency&gt;</span></code></li></ol></pre><p data-anchor-id="jvqr">（3）实现对packetin数据包的统计。在impl/src/main/java/org/opendaylight/defender/impl中新建PacketHandler.java实现PacketProcessingListener接口，重载其中的onPacketReceived(PacketReceived notification)方法，并在该方法中实现对packetin数据包的解析和对门限值的判断，将超过阈值的数据包的相关信息全部发送给处理模块。 <br>
<a href="https://github.com/zhengyjs/TorinoZone/blob/master/实验总结/packet-in-flooding-defence-master.zip" target="_blank">源码文件夹</a></p><ul data-anchor-id="qszh">
<li>重载onPacketReceivered(PacketReceived notification)方法，即通过notification的方式接收、解析packetin消息。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dp4c"><ol class="linenums"><li class="L0"><code><span class="pln">  </span><span class="lit">@Override</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onPacketReceived</span><span class="pun">(</span><span class="typ">PacketReceived</span><span class="pln"> notification</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">      </span><span class="com">// 解析数据包</span></code></li><li class="L3"><code><span class="pln">        ingressNodeConnectorRef </span><span class="pun">=</span><span class="pln"> notification</span><span class="pun">.</span><span class="pln">getIngress</span><span class="pun">();</span></code></li><li class="L4"><code><span class="pln">        ingressNodeConnectorId </span><span class="pun">=</span><span class="pln"> </span><span class="typ">InventoryUtility</span><span class="pun">.</span><span class="pln">getNodeConnectorId</span><span class="pun">(</span><span class="pln">ingressNodeConnectorRef</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">        ingressConnector </span><span class="pun">=</span><span class="pln"> ingressNodeConnectorId</span><span class="pun">.</span><span class="pln">getValue</span><span class="pun">();</span></code></li><li class="L6"><code><span class="pln">        ingressNodeId </span><span class="pun">=</span><span class="pln"> </span><span class="typ">InventoryUtility</span><span class="pun">.</span><span class="pln">getNodeId</span><span class="pun">(</span><span class="pln">ingressNodeConnectorRef</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">        ingressNode </span><span class="pun">=</span><span class="pln"> ingressNodeId</span><span class="pun">.</span><span class="pln">getValue</span><span class="pun">();</span></code></li><li class="L8"><code><span class="pln">        </span><span class="com">// 从notification获取payload</span></code></li><li class="L9"><code><span class="pln">        payload </span><span class="pun">=</span><span class="pln"> notification</span><span class="pun">.</span><span class="pln">getPayload</span><span class="pun">();</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com">// 获取payload的大小</span></code></li><li class="L1"><code><span class="pln">        packetSize </span><span class="pun">=</span><span class="pln"> payload</span><span class="pun">.</span><span class="pln">length</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">        </span><span class="com">// 解析MAC地址</span></code></li><li class="L3"><code><span class="pln">        srcMacRaw </span><span class="pun">=</span><span class="pln"> </span><span class="typ">PacketParsing</span><span class="pun">.</span><span class="pln">extractSrcMac</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">        dstMacRaw </span><span class="pun">=</span><span class="pln"> </span><span class="typ">PacketParsing</span><span class="pun">.</span><span class="pln">extractDstMac</span><span class="pun">(</span><span class="pln">payload</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">        srcMac </span><span class="pun">=</span><span class="pln"> </span><span class="typ">PacketParsing</span><span class="pun">.</span><span class="pln">rawMacToString</span><span class="pun">(</span><span class="pln">srcMacRaw</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pln">        dstMac </span><span class="pun">=</span><span class="pln"> </span><span class="typ">PacketParsing</span><span class="pun">.</span><span class="pln">rawMacToString</span><span class="pun">(</span><span class="pln">dstMacRaw</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">        </span><span class="com">//其它关键信息的解析</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">......</span></code></li><li class="L9"><code><span class="pln">        </span><span class="typ">Lwm</span><span class="pun">();</span><span class="com">//自己定义的处理函数</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="gyqi">其中，InventoryUtility和<a href="https://app.yinxiang.com/fx/508ed532-47d1-4060-81b9-90763c5047eb" target="_blank">PacketParsing</a>均为自己定义的类。</p><ul data-anchor-id="80t6">
<li>计算packetin数据包的平均速率，并根据平均速率做出相应的动作。该部分作为LWM()函数。其中，涉及<a href="https://app.yinxiang.com/fx/d1559162-2be9-4c38-b521-dbdf469304d0" target="_blank">notification</a>和<a href="https://app.yinxiang.com/fx/ff1cb1c0-eb94-4e6b-96a7-863d488a490e" target="_blank">datastore</a>的使用。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="zt80"><ol class="linenums"><li class="L0"><code><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">Lwm</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">        </span><span class="com">// 计数器加1</span></code></li><li class="L2"><code><span class="pln">        counter </span><span class="pun">=</span><span class="pln"> counter </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com">// 计算平均packet in速率</span></code></li><li class="L4"><code><span class="pln">        </span><span class="com">// 收到samplesLwm个数据包以后</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">counter </span><span class="pun">%</span><span class="pln"> samplesLwm</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">            </span><span class="com">// 获取calendar</span></code></li><li class="L7"><code><span class="pln">            calendar </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Calendar</span><span class="pun">.</span><span class="pln">getInstance</span><span class="pun">();</span></code></li><li class="L8"><code><span class="pln">            </span><span class="com">// 获取当前时间，单位为毫秒</span></code></li><li class="L9"><code><span class="pln">            newTime </span><span class="pun">=</span><span class="pln"> calendar</span><span class="pun">.</span><span class="pln">getTimeInMillis</span><span class="pun">();</span></code></li><li class="L0"><code><span class="pln">            </span><span class="com">// 计算时间差</span></code></li><li class="L1"><code><span class="pln">            timeDiff </span><span class="pun">=</span><span class="pln"> newTime </span><span class="pun">-</span><span class="pln"> oldTime</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">            </span><span class="com">// 将oldTime时间更新</span></code></li><li class="L3"><code><span class="pln">            oldTime </span><span class="pun">=</span><span class="pln"> newTime</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">            </span><span class="com">// 收到个数据包的平均速率，单位包/秒</span></code></li><li class="L5"><code><span class="pln">            avgPacketInRate </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">samplesLwm </span><span class="pun">/</span><span class="pln"> timeDiff</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">;</span></code></li><li class="L6"><code><span class="pln">            counter </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L8"><code></code></li><li class="L9"><code><span class="pln">        </span><span class="com">// 如果平均包速率比lowWaterMark值大，说明极有可能已经发生了攻击</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">avgPacketInRate </span><span class="pun">&gt;</span><span class="pln"> lowWaterMark</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com">// lwmBreach的初始值是false，说明第一次超过警戒线，避免重复发送notification</span></code></li><li class="L2"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lwmBreach</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">                </span><span class="com">//设置notification的发送内容，并注册服务</span></code></li><li class="L4"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">            </span><span class="com">// 已经达到警戒线，并已经发出通知</span></code></li><li class="L6"><code><span class="pln">            lwmBreach </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">            </span><span class="com">// 设置dataBroker，将超过警戒线的数据包放入datastore中</span></code></li><li class="L8"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com">// 平均包速率比lowWaterMark小，并且之前达到了lowWaterMark，说明速率已经降下来了，需要将下降的时间点记录到datastore中</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">avgPacketInRate </span><span class="pun">&lt;</span><span class="pln"> lowWaterMark</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> lwmBreach</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com">// 低于警戒线</span></code></li><li class="L2"><code><span class="pln">            lwmBreach </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></code></li><li class="L3"><code><span class="pln">            </span><span class="com">// 将低于lwmWaterMark的时间记录到数据库中</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="qihh"><strong>总之，检测模块（1）将超过警戒线的数据包已经存储到datatstore中；（2）将超过警戒线的数据包通过notification发送到处理模块。</strong></p><div class="md-section-divider"></div><h4 data-anchor-id="7n59" id="三处理模块"><strong>三、处理模块</strong></h4><p data-anchor-id="aemu">处理模块需要接收notification消息，并根据notification消息的<strong>源MAC</strong>和<strong>目的MAC</strong>下发流表。所以，需在impl/src/main/java/org/opendaylight/defender/impl中新建HandlerModule.java类，实现DefenderpluginListener(module名+Listener)接口，并实现onLowWaterMarkBreached(on+notification名)方法。</p><p data-anchor-id="uxh4">（1）解析notification中的srcMAC和dstMAC作为流规则的匹配域,并丢弃对应的流。该函数为createProhibiteFlow(Notification)。其中还包括对流规则其它匹配域的配置。</p><ul data-anchor-id="pnjg">
<li>首先要设置相关的ID。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="z2e1"><ol class="linenums"><li class="L0"><code><span class="com">// 设置名字和tableID以及flowID</span></code></li><li class="L1"><code><span class="com">// 要新建一个Flow先创建相应的Builder类</span></code></li><li class="L2"><code><span class="typ">FlowBuilder</span><span class="pln"> builder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">FlowBuilder</span><span class="pun">();</span></code></li><li class="L3"><code><span class="com">// TableID设置为0，因为有多级流表的概念，一个简单的流只需要设置到第一个流，即ID为0的流表</span></code></li><li class="L4"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setFlowName</span><span class="pun">(</span><span class="str">"prohibitFlow"</span><span class="pun">).</span><span class="pln">setTableId</span><span class="pun">(</span><span class="typ">Short</span><span class="pun">.</span><span class="pln">valueOf</span><span class="pun">(</span><span class="str">"0"</span><span class="pun">));</span></code></li><li class="L5"><code><span class="com">// FlowID只需要和其他Flow区别即可</span></code></li><li class="L6"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setId</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">FlowId</span><span class="pun">(</span><span class="typ">Long</span><span class="pun">.</span><span class="pln">toString</span><span class="pun">(</span><span class="pln">builder</span><span class="pun">.</span><span class="pln">hashCode</span><span class="pun">())));</span></code></li></ol></pre><ul data-anchor-id="pv2w">
<li>然后来设置匹配域。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="toyp"><ol class="linenums"><li class="L0"><code><span class="typ">String</span><span class="pln"> dstMAC </span><span class="pun">=</span><span class="pln"> notification</span><span class="pun">.</span><span class="pln">getDstMac</span><span class="pun">();</span></code></li><li class="L1"><code><span class="typ">String</span><span class="pln"> srcMAC </span><span class="pun">=</span><span class="pln">  notification</span><span class="pun">.</span><span class="pln">getSrcMac</span><span class="pun">();</span></code></li><li class="L2"><code><span class="com">// 首先创建相应的builder</span></code></li><li class="L3"><code><span class="typ">MatchBuilder</span><span class="pln"> matchBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">MatchBuilder</span><span class="pun">();</span></code></li><li class="L4"><code><span class="com">// 匹配域的种类很多，此处需要通过MAC地址匹配</span></code></li><li class="L5"><code><span class="typ">EthernetMatchBuilder</span><span class="pln"> ethernetMatchBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">EthernetMatchBuilder</span><span class="pun">();</span></code></li><li class="L6"><code><span class="com">// 目的地址和源地址都是接口，都需要用相应的builder来赋值和构建</span></code></li><li class="L7"><code><span class="typ">EthernetDestinationBuilder</span><span class="pln"> ethernetDestinationBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">EthernetDestinationBuilder</span><span class="pun">();</span></code></li><li class="L8"><code><span class="pln">ethernetDestinationBuilder</span><span class="pun">.</span><span class="pln">setAddress</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">MacAddress</span><span class="pun">(</span><span class="pln">dstMAC</span><span class="pun">));</span></code></li><li class="L9"><code><span class="pln">ethernetMatchBuilder</span><span class="pun">.</span><span class="pln">setEthernetDestination</span><span class="pun">(</span><span class="pln">ethernetDestinationBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L0"><code><span class="typ">EthernetSourceBuilder</span><span class="pln"> ethernetSourceBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">EthernetSourceBuilder</span><span class="pun">();</span></code></li><li class="L1"><code><span class="pln">ethernetSourceBuilder</span><span class="pun">.</span><span class="pln">setAddress</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">MacAddress</span><span class="pun">(</span><span class="pln">srcMAC</span><span class="pun">));</span></code></li><li class="L2"><code><span class="pln">ethernetMatchBuilder</span><span class="pun">.</span><span class="pln">setEthernetSource</span><span class="pun">(</span><span class="pln">ethernetSourceBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L3"><code><span class="pln">matchBuilder</span><span class="pun">.</span><span class="pln">setEthernetMatch</span><span class="pun">(</span><span class="pln">ethernetMatchBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L4"><code><span class="com">// 匹配域设置好后赋值给Flow的builder</span></code></li><li class="L5"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setMatch</span><span class="pun">(</span><span class="pln">matchBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li></ol></pre><ul data-anchor-id="pad7">
<li>然后来设置相应的规则。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="79w6"><ol class="linenums"><li class="L0"><code><span class="com">// 首先创建相应的builder</span></code></li><li class="L1"><code><span class="typ">InstructionsBuilder</span><span class="pln"> instructionsBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">InstructionsBuilder</span><span class="pun">();</span></code></li><li class="L2"><code><span class="com">// instructionsBuilder需要赋值一个指令列表，需要先构建一个单独的Instruction</span></code></li><li class="L3"><code><span class="typ">InstructionBuilder</span><span class="pln"> instructionBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">InstructionBuilder</span><span class="pun">();</span></code></li><li class="L4"><code><span class="com">// 查看yang文件中instruction是由choice来定义的，我们可以用choice中包含好多case，我们可以选择其中一个case为其赋值，这里选的是apply-actions-case。这个case可以设置一些简单的处理动作比如从哪个端口转发或者是丢弃等</span></code></li><li class="L5"><code><span class="typ">ApplyActionsCaseBuilder</span><span class="pln"> actionsCaseBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ApplyActionsCaseBuilder</span><span class="pun">();</span></code></li><li class="L6"><code><span class="com">// 同样我们需要为actionsCaseBuilder赋值，需要为其赋值一个Action列表</span></code></li><li class="L7"><code><span class="typ">ApplyActionsBuilder</span><span class="pln"> actionsBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ApplyActionsBuilder</span><span class="pun">();</span></code></li><li class="L8"><code><span class="typ">ActionBuilder</span><span class="pln"> actionBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ActionBuilder</span><span class="pun">();</span></code></li><li class="L9"><code><span class="com">// 通过查看yang文件每一个Action实际也是choice定义的，因此同样需要为其选择一个case，因为我们需要让交换机将这个数据流丢弃，因此我们选用drop-action-case</span></code></li><li class="L0"><code><span class="pln">actionBuilder</span><span class="pun">.</span><span class="pln">setAction</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DropActionCaseBuilder</span><span class="pun">().</span><span class="pln">setDropAction</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">DropActionBuilder</span><span class="pun">().</span><span class="pln">build</span><span class="pun">()).</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L1"><code><span class="com">// 最后从Action逐步向外赋值一层一层嵌套最后设置完指令</span></code></li><li class="L2"><code><span class="typ">List</span><span class="pln"> action </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;();</span></code></li><li class="L3"><code><span class="pln">action</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">actionBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L4"><code><span class="pln">actionsBuilder</span><span class="pun">.</span><span class="pln">setAction</span><span class="pun">(</span><span class="pln">action</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">actionsCaseBuilder</span><span class="pun">.</span><span class="pln">setApplyActions</span><span class="pun">(</span><span class="pln">actionsBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L6"><code><span class="pln">instructionBuilder</span><span class="pun">.</span><span class="pln">setInstruction</span><span class="pun">(</span><span class="pln">actionsCaseBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L7"><code><span class="typ">List</span><span class="pln"> instructions </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;();</span></code></li><li class="L8"><code><span class="pln">instructions</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">instructionBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L9"><code><span class="pln">instructionsBuilder</span><span class="pun">.</span><span class="pln">setInstruction</span><span class="pun">(</span><span class="pln">instructions</span><span class="pun">);</span></code></li><li class="L0"><code><span class="com">// 设置指令</span></code></li><li class="L1"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setInstructions</span><span class="pun">(</span><span class="pln">instructionsBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li></ol></pre><ul data-anchor-id="6lv5">
<li>最后来设置该Flow的其他项。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ro8q"><ol class="linenums"><li class="L0"><code><span class="com">// 设置其他项</span></code></li><li class="L1"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setPriority</span><span class="pun">(</span><span class="lit">50</span><span class="pun">);</span></code></li><li class="L2"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setHardTimeout</span><span class="pun">(</span><span class="lit">9999</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">builder</span><span class="pun">.</span><span class="pln">setIdleTimeout</span><span class="pun">(</span><span class="lit">9999</span><span class="pun">);</span></code></li><li class="L4"><code><span class="com">// 全部设置完成后调用build方法并返回</span></code></li><li class="L5"><code><span class="kwd">return</span><span class="pln"> builder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">();</span></code></li></ol></pre><p data-anchor-id="gygl">整个Flow的构建步骤相对繁琐，建议在构建时应该比对Flow的yang文件按照其规定的数据结构一项一项赋值。 <br>
（2）遍历datastore中存储的nodes，即交换机，在所有交换机的table 0 中下发流规则。</p><ul data-anchor-id="m066">
<li>遍历databroker，获得与控制器相连的所有交换机。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="uzh6"><ol class="linenums"><li class="L0"><code><span class="pln"> </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Node</span><span class="pun">&gt;</span><span class="pln"> getAllNodes</span><span class="pun">(</span><span class="typ">DataBroker</span><span class="pln"> dataBroker</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com">// 读取inventory数据库</span></code></li><li class="L2"><code><span class="pln">    </span><span class="typ">InstanceIdentifier</span><span class="pun">.</span><span class="typ">InstanceIdentifierBuilder</span><span class="pun">&lt;</span><span class="typ">Nodes</span><span class="pun">&gt;</span><span class="pln"> nodesInsIdBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="typ">InstanceIdentifier</span><span class="pun">.&lt;</span><span class="typ">Nodes</span><span class="pun">&gt;</span><span class="pln">builder</span><span class="pun">(</span><span class="typ">Nodes</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com">// 两种构建instanceIdentifier的方式</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">// InstanceIdentifier&lt;Nodes&gt; nodesInsIdBuilder = InstanceIdentifier.create(Nodes.class);</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">// 所有节点信息</span></code></li><li class="L6"><code><span class="pln">    </span><span class="typ">Nodes</span><span class="pln"> nodes </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">// 创建读事务</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ReadOnlyTransaction</span><span class="pln"> readOnlyTransaction </span><span class="pun">=</span><span class="pln"> dataBroker</span><span class="pun">.</span><span class="pln">newReadOnlyTransaction</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">    </span><span class="typ">Optional</span><span class="pun">&lt;</span><span class="typ">Nodes</span><span class="pun">&gt;</span><span class="pln"> dataObjectOptional </span><span class="pun">=</span><span class="pln"> readOnlyTransaction</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="typ">LogicalDatastoreType</span><span class="pun">.</span><span class="pln">OPERATIONAL</span><span class="pun">,</span><span class="pln"> nodesInsIdBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">()).</span><span class="kwd">get</span><span class="pun">();</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com">// 如果数据不为空，获取到nodes</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dataObjectOptional</span><span class="pun">.</span><span class="pln">isPresent</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">            nodes </span><span class="pun">=</span><span class="pln"> dataObjectOptional</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">();</span></code></li><li class="L3"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">InterruptedException</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">        LOG</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="str">"Failed to read nodes from Operation data store."</span><span class="pun">);</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RuntimeException</span><span class="pun">(</span><span class="str">"Failed to read nodes from Operation data store."</span><span class="pun">,</span><span class="pln"> e</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ExecutionException</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">        LOG</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="str">"Failed to read nodes from Operation data store."</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">throw</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">RuntimeException</span><span class="pun">(</span><span class="str">"Failed to read nodes from Operation data store."</span><span class="pun">,</span><span class="pln"> e</span><span class="pun">);</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> nodes</span><span class="pun">.</span><span class="pln">getNode</span><span class="pun">();</span></code></li><li class="L2"><code><span class="pun">}</span></code></li></ol></pre><ul data-anchor-id="szqy">
<li>将规则下发给交换机。</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="3b1p"><ol class="linenums"><li class="L0"><code><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> addProhibitFlow</span><span class="pun">(</span><span class="typ">InstanceIdentifier</span><span class="pun">&lt;</span><span class="typ">Node</span><span class="pun">&gt;</span><span class="pln"> nodeId</span><span class="pun">,</span><span class="typ">Flow</span><span class="pln"> flow</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com">// node 是遍历datastore中nodeids中的每一个nodeid</span></code></li><li class="L2"><code><span class="pln">    LOG</span><span class="pun">.</span><span class="pln">info</span><span class="pun">(</span><span class="str">"Adding prohibit flows for node {} "</span><span class="pun">,</span><span class="pln"> nodeId</span><span class="pun">);</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com">// 根据nodeId获取tableId</span></code></li><li class="L4"><code><span class="pln">    </span><span class="typ">InstanceIdentifier</span><span class="pun">&lt;</span><span class="typ">Table</span><span class="pun">&gt;</span><span class="pln"> tableId </span><span class="pun">=</span><span class="pln"> getTableInstanceId</span><span class="pun">(</span><span class="pln">nodeId</span><span class="pun">);</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">// 创建一个FlowKey</span></code></li><li class="L6"><code><span class="pln">    </span><span class="typ">FlowKey</span><span class="pln"> flowKey </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">FlowKey</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">FlowId</span><span class="pun">(</span><span class="pln">FLOW_ID_PREFIX </span><span class="pun">+</span><span class="pln"> </span><span class="typ">String</span><span class="pun">.</span><span class="pln">valueOf</span><span class="pun">(</span><span class="pln">flowNo</span><span class="pun">++)));</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">// 在datastore中创建一个子路经</span></code></li><li class="L8"><code><span class="pln">    </span><span class="typ">InstanceIdentifier</span><span class="pun">&lt;</span><span class="typ">Flow</span><span class="pun">&gt;</span><span class="pln"> flowId </span><span class="pun">=</span><span class="pln"> tableId</span><span class="pun">.</span><span class="pln">child</span><span class="pun">(</span><span class="typ">Flow</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">,</span><span class="pln"> flowKey</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pln">    </span><span class="com">// 在这个子路经下添加一个流</span></code></li><li class="L0"><code><span class="pln">    </span><span class="typ">Future</span><span class="pun">&lt;</span><span class="typ">RpcResult</span><span class="pun">&lt;</span><span class="typ">AddFlowOutput</span><span class="pun">&gt;&gt;</span><span class="pln"> result </span><span class="pun">=</span><span class="pln"> writeFlow</span><span class="pun">(</span><span class="pln">nodeId</span><span class="pun">,</span><span class="pln"> tableId</span><span class="pun">,</span><span class="pln"> flowId</span><span class="pun">,</span><span class="pln">flow</span><span class="pun">);</span></code></li><li class="L1"><code><span class="pln">    </span><span class="typ">AddFlowOutput</span><span class="pln"> output </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">        output </span><span class="pun">=</span><span class="pln"> result</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">().</span><span class="pln">getResult</span><span class="pun">();</span></code></li><li class="L4"><code><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">InterruptedException</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> </span><span class="typ">ExecutionException</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">        </span><span class="com">// TODO Auto-generated catch block</span></code></li><li class="L6"><code><span class="pln">        e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pln">    LOG</span><span class="pun">.</span><span class="pln">info</span><span class="pun">(</span><span class="str">"Added prohibit flows for node {} "</span><span class="pun">,</span><span class="pln"> nodeId</span><span class="pun">);</span></code></li><li class="L9"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="snt4" id="四用户模块"><strong>四、用户模块</strong></h4><p data-anchor-id="t3v4">此模块主要由RPC组成，方便用户通过(被)攻击者IP找到(被)攻击者IP，并在网页上显示相关信息。 <br>
（1）在api/src/main/yang/defenderplugin.yang中加入RPC定义。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="afb1"><ol class="linenums"><li class="L0"><code><span class="com">// 根据源IP地址来查找攻击</span></code></li><li class="L1"><code><span class="pln">    rpc attacksFromIP </span><span class="pun">{</span></code></li><li class="L2"><code><span class="pln">        input </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">            leaf </span><span class="typ">SrcIP</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L5"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L6"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        output </span><span class="pun">{</span></code></li><li class="L8"><code><span class="pln">            uses alert</span><span class="pun">;</span></code></li><li class="L9"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L0"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">    </span><span class="com">// 根据目的IP地址来查找攻击</span></code></li><li class="L2"><code><span class="pln">    rpc attacksToIP </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">        input </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">            leaf </span><span class="typ">DstIP</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L6"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L7"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pln">        output </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">            uses alert</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L2"><code><span class="pln">    </span><span class="com">// 根据时间和窗口获取攻击</span></code></li><li class="L3"><code><span class="pln">    rpc attacksInTime </span><span class="pun">{</span></code></li><li class="L4"><code><span class="pln">        input </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">            leaf </span><span class="typ">FromTime</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L7"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pln">            leaf </span><span class="typ">EndTime</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">                type </span><span class="kwd">string</span><span class="pun">;</span></code></li><li class="L0"><code><span class="pln">            </span><span class="pun">}</span></code></li><li class="L1"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L2"><code><span class="pln">        output </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">            uses alert</span><span class="pun">;</span></code></li><li class="L4"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="f3ba">（2）在impl/src/main/java/org/opendaylight/defender/impl中新建DefenderRPCImpl.java，实现通过(被)攻击者IP或者攻击时间找到攻击信息。要实现RPC功能，需要实现DefenderpluginService(module名+Service)接口。<strong>这个过程类似于DataStore的逆过程，即将datastore中的信息逐步抽取出来。</strong> <br>
以其中一个为例，进行简要说明。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="rbjg"><ol class="linenums"><li class="L0"><code><span class="com">/**</span></code></li><li class="L1"><code><span class="com">* 根据源IP地址来返回攻击记录</span></code></li><li class="L2"><code><span class="com">*/</span></code></li><li class="L3"><code><span class="lit">@Override</span></code></li><li class="L4"><code><span class="kwd">public</span><span class="pln"> </span><span class="typ">Future</span><span class="pun">&lt;</span><span class="typ">RpcResult</span><span class="pun">&lt;</span><span class="typ">AttacksFromIPOutput</span><span class="pun">&gt;&gt;</span><span class="pln"> attacksFromIP</span><span class="pun">(</span><span class="typ">AttacksFromIPInput</span><span class="pln"> input</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code><span class="pln">    </span><span class="com">// 从输入中获取源IP地址</span></code></li><li class="L6"><code><span class="pln">    </span><span class="typ">String</span><span class="pln"> srcIP </span><span class="pun">=</span><span class="pln"> input</span><span class="pun">.</span><span class="pln">getSrcIP</span><span class="pun">();</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">// 用DataBroker建立只读事务</span></code></li><li class="L8"><code><span class="pln">    </span><span class="typ">ReadOnlyTransaction</span><span class="pln"> readOnly </span><span class="pun">=</span><span class="pln"> dataBroker</span><span class="pun">.</span><span class="pln">newReadOnlyTransaction</span><span class="pun">();</span></code></li><li class="L9"><code><span class="pln">    </span><span class="com">// 从该路径下获取所有攻击记录然后根据条件筛选返回</span></code></li><li class="L0"><code><span class="pln">    </span><span class="typ">InstanceIdentifier</span><span class="pun">&lt;</span><span class="pln">LWM</span><span class="pun">&gt;</span><span class="pln"> instanceIdentifier </span><span class="pun">=</span><span class="pln"> </span><span class="typ">InstanceIdentifier</span><span class="pun">.</span><span class="pln">builder</span><span class="pun">(</span><span class="pln">LWM</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">).</span><span class="pln">build</span><span class="pun">();</span></code></li><li class="L1"><code><span class="pln">    </span><span class="typ">Optional</span><span class="pun">&lt;</span><span class="pln">LWM</span><span class="pun">&gt;</span><span class="pln"> results </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code><span class="pln">        </span><span class="com">// 从该路径中读取结果</span></code></li><li class="L4"><code><span class="pln">        results </span><span class="pun">=</span><span class="pln"> readOnly</span><span class="pun">.</span><span class="pln">read</span><span class="pun">(</span><span class="typ">LogicalDatastoreType</span><span class="pun">.</span><span class="pln">OPERATIONAL</span><span class="pun">,</span><span class="pln"> instanceIdentifier</span><span class="pun">).</span><span class="kwd">get</span><span class="pun">();</span></code></li><li class="L5"><code><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="typ">InterruptedException</span><span class="pln"> </span><span class="pun">|</span><span class="pln"> </span><span class="typ">ExecutionException</span><span class="pln"> e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code><span class="pln">        e</span><span class="pun">.</span><span class="pln">printStackTrace</span><span class="pun">();</span></code></li><li class="L7"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L8"><code><span class="pln">    LWM lwm </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L9"><code><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">results</span><span class="pun">.</span><span class="pln">isPresent</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code><span class="pln">        </span><span class="com">// 获取LWM</span></code></li><li class="L1"><code><span class="pln">        lwm </span><span class="pun">=</span><span class="pln"> results</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">();</span></code></li><li class="L2"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">    </span><span class="com">// 获取LWM中的Lowwatermark</span></code></li><li class="L4"><code><span class="pln">    </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Lowwatermark</span><span class="pun">&gt;</span><span class="pln"> resultList </span><span class="pun">=</span><span class="pln"> lwm</span><span class="pun">.</span><span class="pln">getLowwatermark</span><span class="pun">();</span></code></li><li class="L5"><code><span class="pln">    </span><span class="typ">List</span><span class="pun">&lt;</span><span class="typ">Alerts</span><span class="pun">&gt;</span><span class="pln"> alerts </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayList</span><span class="pun">&lt;&gt;();</span></code></li><li class="L6"><code><span class="pln">    </span><span class="typ">AlertsBuilder</span><span class="pln"> builder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">AlertsBuilder</span><span class="pun">();</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">// 遍历从数据库中读取的每一项记录</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Lowwatermark</span><span class="pln"> low </span><span class="pun">:</span><span class="pln"> resultList</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code><span class="pln">        </span><span class="com">// 按照源IP地址进行筛选</span></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getSrcIP</span><span class="pun">().</span><span class="pln">equals</span><span class="pun">(</span><span class="pln">srcIP</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code><span class="pln">            </span><span class="com">// 设置alert</span></code></li><li class="L2"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setDownTime</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getDownwardTime</span><span class="pun">());</span></code></li><li class="L3"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setUpTime</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getUpwardTime</span><span class="pun">());</span></code></li><li class="L4"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setDstIP</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getDstIP</span><span class="pun">());</span></code></li><li class="L5"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setSrcIP</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getSrcIP</span><span class="pun">());</span></code></li><li class="L6"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setDstMac</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getDstMAC</span><span class="pun">());</span></code></li><li class="L7"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setSrcMac</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getSrcMAC</span><span class="pun">());</span></code></li><li class="L8"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setDstPort</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getDstPort</span><span class="pun">());</span></code></li><li class="L9"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setSrcPort</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getSrcPort</span><span class="pun">());</span></code></li><li class="L0"><code><span class="pln">            builder</span><span class="pun">.</span><span class="pln">setProtocol</span><span class="pun">(</span><span class="pln">low</span><span class="pun">.</span><span class="pln">getProtocol</span><span class="pun">());</span></code></li><li class="L1"><code><span class="pln">            alerts</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">builder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">());</span></code></li><li class="L2"><code><span class="pln">        </span><span class="pun">}</span></code></li><li class="L3"><code><span class="pln">    </span><span class="pun">}</span></code></li><li class="L4"><code><span class="pln">    </span><span class="com">// 创建Output的builder类并将相关记录赋值</span></code></li><li class="L5"><code><span class="pln">    </span><span class="typ">AttacksFromIPOutputBuilder</span><span class="pln"> outputBuilder </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">AttacksFromIPOutputBuilder</span><span class="pun">();</span></code></li><li class="L6"><code><span class="pln">    outputBuilder</span><span class="pun">.</span><span class="pln">setAlerts</span><span class="pun">(</span><span class="pln">alerts</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pln">    </span><span class="com">// 最后用RpcResultBuilder构建Future来返回</span></code></li><li class="L8"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">RpcResultBuilder</span><span class="pun">.</span><span class="pln">success</span><span class="pun">(</span><span class="pln">outputBuilder</span><span class="pun">.</span><span class="pln">build</span><span class="pun">()).</span><span class="pln">buildFuture</span><span class="pun">();</span><span class="pln">   </span></code></li><li class="L9"><code><span class="pun">}</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="z0mc" id="五注册模块"><strong>五、注册模块</strong></h4><p data-anchor-id="7i4e">这部分是将之前应该注册的部分进行注册。OSGi中将服务进行注册，可以实现bundle之间的相互import。 <br>
（1）在 <em>监测模块</em> 中，PacketHandle.java需要注册notification，因为要接收packetin消息的notification，即notificationService。同时还要发送notification给处理模块，即notificationPublishService。 <br>
（2）在 <em>处理模块</em> 中，HandleModule.java需要接收监测模块的notification，即notificationService。 <br>
（3）在 <em>用户模块</em> 中，DefenderRPCImpl.java需要注册RPC服务。 <br>
所以，要在impl/src/main/resources/org/opendaylight/blueprint/impl-blueprint.xml中对以上文件进行注册。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="xerz"><ol class="linenums"><li class="L0"><code class="language-xml"><span class="com">&lt;!-- 需要调用的接口 --&gt;</span><span class="pln"> </span></code></li><li class="L1"><code class="language-xml"><span class="tag">&lt;reference</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"dataBroker"</span></code></li><li class="L2"><code class="language-xml"><span class="pln">  </span><span class="atn">interface</span><span class="pun">=</span><span class="atv">"org.opendaylight.controller.md.sal.binding.api.DataBroker"</span></code></li><li class="L3"><code class="language-xml"><span class="pln">  </span><span class="atn">odl:type</span><span class="pun">=</span><span class="atv">"default"</span><span class="pln"> </span><span class="tag">/&gt;</span></code></li><li class="L4"><code class="language-xml"><span class="tag">&lt;odl:rpc-service</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"salFlowService"</span><span class="pln"> </span></code></li><li class="L5"><code class="language-xml"><span class="pln">  </span><span class="atn">interface</span><span class="pun">=</span><span class="atv">"org.opendaylight.yang.gen.v1.urn.opendaylight.flow.service.rev130819.SalFlowService"</span><span class="tag">/&gt;</span></code></li><li class="L6"><code class="language-xml"><span class="tag">&lt;reference</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"notificationPublishService"</span></code></li><li class="L7"><code class="language-xml"><span class="pln">  </span><span class="atn">interface</span><span class="pun">=</span><span class="atv">"org.opendaylight.controller.md.sal.binding.api.NotificationPublishService"</span><span class="tag">/&gt;</span></code></li><li class="L8"><code class="language-xml"></code></li><li class="L9"><code class="language-xml"><span class="com">&lt;!--(1)notificationService--&gt;</span></code></li><li class="L0"><code class="language-xml"><span class="tag">&lt;bean</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"packetHandler"</span></code></li><li class="L1"><code class="language-xml"><span class="pln">  </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"org.opendaylight.defender.impl.PacketHandler"</span><span class="tag">&gt;</span></code></li><li class="L2"><code class="language-xml"><span class="pln">  </span><span class="tag">&lt;argument</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"dataBroker"</span><span class="tag">/&gt;</span></code></li><li class="L3"><code class="language-xml"><span class="pln">  </span><span class="tag">&lt;argument</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"notificationPublishService"</span><span class="tag">/&gt;</span><span class="pln">  </span></code></li><li class="L4"><code class="language-xml"><span class="tag">&lt;/bean&gt;</span></code></li><li class="L5"><code class="language-xml"><span class="com">&lt;!--(2)notificationService--&gt;</span></code></li><li class="L6"><code class="language-xml"><span class="tag">&lt;bean</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"handlerModule"</span></code></li><li class="L7"><code class="language-xml"><span class="pln">  </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"org.opendaylight.defender.impl.HandlerModule"</span><span class="tag">&gt;</span></code></li><li class="L8"><code class="language-xml"><span class="pln">  </span><span class="tag">&lt;argument</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"dataBroker"</span><span class="tag">/&gt;</span></code></li><li class="L9"><code class="language-xml"><span class="pln">  </span><span class="tag">&lt;argument</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"salFlowService"</span><span class="tag">/&gt;</span><span class="pln">  </span></code></li><li class="L0"><code class="language-xml"><span class="tag">&lt;/bean&gt;</span></code></li><li class="L1"><code class="language-xml"><span class="com">&lt;!--(3)--&gt;</span></code></li><li class="L2"><code class="language-xml"><span class="tag">&lt;bean</span><span class="pln"> </span><span class="atn">id</span><span class="pun">=</span><span class="atv">"defenderRPCImpl"</span></code></li><li class="L3"><code class="language-xml"><span class="pln">  </span><span class="atn">class</span><span class="pun">=</span><span class="atv">"org.opendaylight.defender.impl.DefenderRPCImpl"</span><span class="tag">&gt;</span></code></li><li class="L4"><code class="language-xml"><span class="pln">  </span><span class="tag">&lt;argument</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"dataBroker"</span><span class="tag">/&gt;</span></code></li><li class="L5"><code class="language-xml"><span class="tag">&lt;/bean&gt;</span></code></li><li class="L6"><code class="language-xml"><span class="com">&lt;!-- 注册notification的接收者notificationPublishService和RPC的实现类 --&gt;</span></code></li><li class="L7"><code class="language-xml"><span class="tag">&lt;odl:notification-listener</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"handlerModule"</span><span class="tag">/&gt;</span></code></li><li class="L8"><code class="language-xml"><span class="tag">&lt;odl:notification-listener</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"packetHandler"</span><span class="tag">/&gt;</span></code></li><li class="L9"><code class="language-xml"><span class="tag">&lt;odl:rpc-implementation</span><span class="pln"> </span><span class="atn">ref</span><span class="pun">=</span><span class="atv">"defenderRPCImpl"</span><span class="tag">/&gt;</span></code></li></ol></pre><div class="md-section-divider"></div><h4 data-anchor-id="0f2y" id="六测试"><strong>六、测试</strong></h4><p data-anchor-id="8jp9">（1）在defender目录下进行编译</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6a92"><ol class="linenums"><li class="L0"><code><span class="pln">mvn clean install </span><span class="pun">-</span><span class="typ">DskipTests</span></code></li></ol></pre><p data-anchor-id="cgin">（2）打开defender/karaf/target/assembly/bin下的karaf，安装对应的features，并打开log:tail日志窗口。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="4fk3"><ol class="linenums"><li class="L0"><code><span class="com">//支持REST API访问Datastore</span></code></li><li class="L1"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">restconf</span><span class="pun">-</span><span class="pln">all</span></code></li><li class="L2"><code><span class="com">//提供2层转发的交换机</span></code></li><li class="L3"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">l2switch</span><span class="pun">-</span><span class="kwd">switch</span><span class="pun">-</span><span class="pln">ui </span></code></li><li class="L4"><code><span class="com">//提供openflow协议</span></code></li><li class="L5"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">openflowplugin</span><span class="pun">-</span><span class="pln">flow</span><span class="pun">-</span><span class="pln">services</span><span class="pun">-</span><span class="pln">ui </span></code></li><li class="L6"><code><span class="com">//提供mdsal组件</span></code></li><li class="L7"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">mdsal</span><span class="pun">-</span><span class="pln">all</span></code></li><li class="L8"><code><span class="com">//API查看器</span></code></li><li class="L9"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">dluxapps</span><span class="pun">-</span><span class="pln">applications</span></code></li><li class="L0"><code><span class="pln">feature</span><span class="pun">:</span><span class="pln">install odl</span><span class="pun">-</span><span class="pln">dluxapps</span><span class="pun">-</span><span class="pln">yangutils</span></code></li></ol></pre><p data-anchor-id="g3ut">（3）功能测试</p><ul data-anchor-id="jg2e">
<li>创建拓扑</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="t03n"><ol class="linenums"><li class="L0"><code><span class="com"># mn --controller=remote --topo=linear,3 //控制器的日志窗口显示连接</span></code></li></ol></pre><p data-anchor-id="hnb2"><a href="https://imgchr.com/i/nStx78" target="_blank"><img src="https://s2.ax1x.com/2019/09/01/nStx78.png" alt="nStx78.png" title=""></a></p><ul data-anchor-id="u4an">
<li>模拟flood攻击</li>
</ul><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="i8qj"><ol class="linenums"><li class="L0"><code><span class="pln">mininet</span><span class="pun">&gt;</span><span class="pln">h1 ping </span><span class="pun">-</span><span class="pln">f h2 </span><span class="com">//-f为极限测试</span></code></li></ol></pre><ul data-anchor-id="vpsq">
<li>运行结果 <br>
1）ODL控制器：显示PacketHandler.java和HanderModule.java的运行。 <br>
<a href="https://imgchr.com/i/nVTl2n" target="_blank"><img src="https://s2.ax1x.com/2019/09/04/nVTl2n.png" alt="nVTl2n.png" title=""></a> <br>
<a href="https://imgchr.com/i/nVTQ8s" target="_blank"><img src="https://s2.ax1x.com/2019/09/04/nVTQ8s.png" alt="nVTQ8s.png" title=""></a> <br>
2）mininet：流表内容发生变化。 <br>
<a href="https://imgchr.com/i/nVTMCj" target="_blank"><img src="https://s2.ax1x.com/2019/09/04/nVTMCj.png" alt="nVTMCj.png" title=""></a> <br>
3）在 <a href="http://localhost:8181/index.html" target="_blank">http://localhost:8181/index.html</a> 中yangman-&gt;MODULE-&gt;defenderplugin rev2018-07-21-&gt;operations中，可以通过RPC查看结果。 <br>
<a href="https://imgchr.com/i/nVbTqx" target="_blank"><img src="https://s2.ax1x.com/2019/09/04/nVbTqx.png" alt="nVbTqx.png" title=""></a></li>
</ul><p data-anchor-id="35et"><strong>总结</strong>：开发ODL项目，要先从定义yang文件开始，然后完善java文件实现，其中会存在各种依赖关系，要在pom.xml中定义好。</p></div>
</body>
</html>